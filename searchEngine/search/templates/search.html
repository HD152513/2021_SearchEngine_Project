<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{STATIC_URL}}css/searchstyle.css">
    <title>Document</title>
    
</head>
<body>
    <div class="all">
        <div class="search-bar">
            <p class="logo" onclick="location.href='/';">네돈네산</p>
            <input id="searchVal" class="search-box" type="text" placeholder="제품명을 입력해주세요."/>
            <button id="search" class="search-icon" type="submit"><img src="{{STATIC_URL}}img/search_icon.png" alt=""></button>
        </div>    
        <div class="container">
            <div class="searchResult">
                <div class="tab">
                    <button id="realBtn" onclick="realBtnClick();">네돈네산 리뷰</button>
                    <button id="adBtn" onclick="adBtnClick();">광고 리뷰</button>
                </div>
                <div class="chart-index">
                    <div id=positive></div>
                    <div>긍정</div>
                    <div id=negative></div>
                    <div>부정</div>
                </div>
                <!-- 진짜 후기 내용 -->
                <div id="realReview">
                    <div width= '100%' height= '75vh' style="text-align: center; margin-top: 32vh;">
                        <img src="{{STATIC_URL}}img/loading.gif" alt="loading" width="100px">
                    </div>
                </div>
                <!-- 가짜 후기 내용 -->
                <div id="adReview" style="display: none;">
                    <div width= '100%' height= '75vh' style="text-align: center; margin-top: 32vh;">
                        <img src="{{STATIC_URL}}img/loading.gif" alt="loading" width="100px">
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="{{STATIC_URL}}common.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous" charset="UTF-8"></script>
<script>
    $(document).ready(function() {
        $.ajax({ 
            url:'https://sfrketwhk3.execute-api.ap-northeast-2.amazonaws.com/V3/search/{{searchVal}}', 
            success:function(data){ 
                showData(data); 
                $.ajax({ 
                    type: "POST",
                    url:'https://sfrketwhk3.execute-api.ap-northeast-2.amazonaws.com/V3/comprehend', 
                    'data': data,
                    success:function(data){ 
                        console.log(data);
                    } 
                });
            } 
        });
        
    });
    

    function showData(data) {
        data = JSON.parse(data);
        var strReal = '';
        var strAd = '';
        var startGoogle = 0;
        var endNaver = 0
        for (let i = data.length - 1; i >= 0; i--){
            if (data[i].source == 'N'){
                startGoogle = i + 1;
                break;
            }
        }
        if (startGoogle == 0){
            endNaver = data.length;
        }else{
            endNaver = startGoogle;
        }
        for (var i = 0; i < startGoogle; i++){
            if (!data[i].isAd){
                strReal += '<div class="box">';
                strReal += '<img class="site_logo"';
                if (data[i].source == 'G'){
                    strReal += 'src="{{STATIC_URL}}img/googleicon.png" width="40" height="40" alt="Google logo">';
                } else{
                    strReal += 'src="{{STATIC_URL}}img/navericon.png" width="40" height="40" alt="Naver logo">';
                }
                strReal += '<div class="review"><div class="title">';
                strReal += '<a href="' + data[i].linkUrl + '" target="_blank" id="review_title">'+ data[i].title + '</a><br>';
                strReal += '<a href="' + data[i].linkUrl + '" target="_blank" class="linkUrl">' + data[i].linkUrl+ '</a></a></div>';
                strReal += '<div class="summary">'
                strReal += '<span>요약된 첫번째 내용이 담길 공간입니다.<br>요약된 두번째 내용이 담길 공간입니다.<br>요약된 세번째 내용이 담길 공간입니다.</span>'
                strReal += '</div>'
                strReal += '</div><div class="chart"><canvas id="canvas' + data[i].id + '" width=145 height=145></canvas></div></div>'
            }else{
                strAd += '<div class="box">';
                strAd += '<img class="site_logo"';
                if (data[i].source == 'G'){
                    strAd += 'src="{{STATIC_URL}}img/googleicon.png" width="40" height="40" alt="Google logo">';
                } else{
                    strAd += 'src="{{STATIC_URL}}img/navericon.png" width="40" height="40" alt="Naver logo">';
                }
                strAd += '<div class="review"><div class="title">';
                strAd += '<a href="' + data[i].linkUrl + '" target="_blank" id="review_title">'+ data[i].title + '</a><br>';
                strAd += '<a href="' + data[i].linkUrl + 'target="_blank" class="linkUrl">'+ data[i].linkUrl + '</a></a></div>';
                strAd += '<div class="summary">'
                strAd += '<span>요약된 첫번째 내용이 담길 공간입니다.<br>요약된 두번째 내용이 담길 공간입니다.<br>요약된 세번째 내용이 담길 공간입니다.</span>'
                strAd += '</div>'
                strAd += '</div><div class="chart"><canvas id="canvas' + data[i].id + '" width=145 height=145></canvas></div></div>'
            }
            if (data[i+startGoogle]){
                if (!data[i+startGoogle].isAd){
                    strReal += '<div class="box">';
                    strReal += '<img class="site_logo"';
                    if (data[i+startGoogle].source == 'G'){
                        strReal += 'src="{{STATIC_URL}}img/googleicon.png" width="40" height="40" alt="Google logo">';
                    } else{
                        strReal += 'src="{{STATIC_URL}}img/navericon.png" width="40" height="40" alt="Naver logo">';
                    }
                    strReal += '<div class="review"><div class="title">';
                    strReal += '<a href="' + data[i+startGoogle].linkUrl + '" target="_blank" id="review_title">'+ data[i+startGoogle].title + '</a><br>';
                    strReal += '<a href="' + data[i+startGoogle].linkUrl + '" target="_blank" class="linkUrl">' + data[i+startGoogle].linkUrl+ '</a></a></div>';
                    strReal += '<div class="summary">'
                    strReal += '<span>요약된 첫번째 내용이 담길 공간입니다.<br>요약된 두번째 내용이 담길 공간입니다.<br>요약된 세번째 내용이 담길 공간입니다.</span>'
                    strReal += '</div>'
                    strReal += '</div><div class="chart"><canvas id="canvas' + data[i+startGoogle].id + '" width=145 height=145></canvas></div></div>'
                }else{
                    strAd += '<div class="box">';
                    strAd += '<img class="site_logo"';
                    if (data[i+startGoogle].source == 'G'){
                        strAd += 'src="{{STATIC_URL}}img/googleicon.png" width="40" height="40" alt="Google logo">';
                    } else{
                        strAd += 'src="{{STATIC_URL}}img/navericon.png" width="40" height="40" alt="Naver logo">';
                    }
                    strAd += '<div class="review"><div class="title">';
                    strAd += '<a href="' + data[i+startGoogle].linkUrl + '" target="_blank" id="review_title">'+ data[i+startGoogle].title + '</a><br>';
                    strAd += '<a href="' + data[i+startGoogle].linkUrl + 'target="_blank" class="linkUrl">'+ data[i+startGoogle].linkUrl + '</a></a></div>';
                    strAd += '<div class="summary">'
                    strAd += '<span>요약된 첫번째 내용이 담길 공간입니다.<br>요약된 두번째 내용이 담길 공간입니다.<br>요약된 세번째 내용이 담길 공간입니다.</span>'
                    strAd += '</div>'
                    strAd += '</div><div class="chart"><canvas id="canvas' + data[i+startGoogle].id + '" width=145 height=145></canvas></div></div>'
                }
            }
        }

        document.getElementById("realReview").innerHTML = strReal;
        document.getElementById("adReview").innerHTML = strAd;
        
        // var box=document.getElementsByClassName("box");


        for(var i=0;i <data.length;i++){
            let canvas=document.getElementById("canvas"+data[i].id);
            let colors=['#30343B','#FFD368'];
            let ctx=canvas.getContext("2d");
            let values=[25,75]; //긍부정비율 넘겨줄때 넣으면 될듯
            let labels=['Positive','Negative'];
            Chart(72.5,72.5,45,35,values,colors,labels,ctx);
        }

        function Chart(cx,cy,radius,arcwidth,values,colors,labels,ctx){
            var tot=0;
            var accum=0;
            var PI=Math.PI;
            var PI2=PI*2;
            var offset=-PI/2;
            ctx.lineWidth=arcwidth;
            for(var i=0;i<values.length;i++){tot+=values[i];}
            for(var i=0;i<values.length;i++){
                ctx.beginPath();
                ctx.arc(cx,cy,radius,
                    offset+PI2*(accum/tot),
                    offset+PI2*((accum+values[i])/tot)
                );
                ctx.strokeStyle=colors[i];
                ctx.stroke();
                accum+=values[i];
            }
        }

    }

    let realBtn = document.getElementById("realBtn");
    let adBtn = document.getElementById("adBtn"); 
    let realRv = document.getElementById("realReview");
    let adRv = document.getElementById("adReview");
    document.getElementById("searchVal").value = '{{searchVal}}'
    function realBtnClick() {
        realBtn.style.background = "#30343B";
        realBtn.style.color = "white";
        realBtn.style.border = 0;
        adBtn.style.background = "#fff";
        adBtn.style.color = "#30343B";
        adBtn.style.border = "1px solid";
        realRv.style.display = "";
        adRv.style.display = "none";
    };
    function adBtnClick(){
        realBtn.style.background = "#fff";
        realBtn.style.color = "#30343B";
        realBtn.style.border = "1px solid";
        adBtn.style.background = "#30343B";
        adBtn.style.color = "white";
        adBtn.style.border = 0;
        realRv.style.display = "none";
        adRv.style.display = "";
    };

    
    
    
</script>
</html>